<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>TaxSyncQC ‚Äî Estimateur d'imp√¥t Qu√©bec</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; max-width: 600px; margin: 2rem auto; padding: 0 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
    .container { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
    h1 { color: #667eea; margin: 0 0 0.5rem 0; }
    .drop { border: 2px dashed #ccc; border-radius: 8px; padding: 2rem; text-align: center; margin: 1rem 0; background: #fafafa; transition: all 0.3s; }
    .drop:hover { border-color: #667eea; background: #f0f4ff; }
    .result { background: #e6f7ff; border-left: 4px solid #1890ff; padding: 1rem; margin: 1rem 0; border-radius: 4px; display: none; }
    .lang-toggle { text-align: right; margin-bottom: 1rem; }
    .lang-toggle button { border: none; background: none; cursor: pointer; padding: 0.5rem 1rem; font-size: 14px; }
    .warning { color: #fa8c16; }
    button.primary { background: #667eea; color: white; border: none; padding: 0.75rem 2rem; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; }
    button.primary:hover { background: #5568d3; }
    button.secondary { background: #e0e0e0; color: #333; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer; margin-left: 0.5rem; }
    textarea { width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; font-family: monospace; font-size: 14px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="lang-toggle">
      <button onclick="setLang('en')" id="btn-en">EN</button>
      <button onclick="setLang('fr')" id="btn-fr">FR</button>
    </div>

    <h1 id="title">üí∞ TaxSyncQC ‚Äî Quebec Tax Estimator</h1>
    <p id="subtitle"><strong>Quebec 2025 tax credit estimator</strong></p>

    <div class="drop" id="dropZone">
      üìÑ Drop RL-1 PDF here<br>or<br>
      <input type="file" id="fileInput" accept=".pdf,.txt" style="display:none"/>
      <button onclick="document.getElementById('fileInput').click()">Choose File</button>
    </div>

    <p id="paste-label">Or paste RL-1 text:</p>
    <textarea id="textInput" rows="6" placeholder="Case A: 35000&#10;Case C: 2120&#10;Case L: 300"></textarea>
    <br><br>
    <button class="primary" onclick="estimate()">Estimate Refund</button>
    <button class="secondary" onclick="clearForm()">Clear</button>

    <div id="output"></div>
  </div>

  <script>
    const translations = {
      en: {
        title: "üí∞ TaxSyncQC ‚Äî Quebec Tax Estimator",
        subtitle: "Quebec 2025 tax credit estimator",
        pasteLabel: "Or paste RL-1 text:",
        estimateBtn: "Estimate Refund",
        clearBtn: "Clear",
        income: "Income",
        solidarity: "Solidarity Credit",
        workPremium: "Work Premium",
        bpaSavings: "BPA Savings",
        cwb: "CWB (cash)",
        qcTotal: "QC Total",
        fedTotal: "Fed Total",
        totalBenefit: "Total Benefit",
        cashBack: "Cash Back",
        warnings: "‚ö†Ô∏è Warnings:",
        missingUnionDues: "Union dues (Case L) missing",
        missingSIN: "SIN missing",
        invalidRL1: "‚ùå Invalid RL-1 ‚Äî check Case A"
      },
      fr: {
        title: "üí∞ TaxSyncQC ‚Äî Estimateur Qu√©bec",
        subtitle: "Estimateur cr√©dits 2025",
        pasteLabel: "Ou collez RL-1:",
        estimateBtn: "Estimer",
        clearBtn: "Effacer",
        income: "Revenu",
        solidarity: "Cr√©dit solidarit√©",
        workPremium: "Prime travail",
        bpaSavings: "√âconomies BPA",
        cwb: "PTE",
        qcTotal: "Total QC",
        fedTotal: "Total f√©d√©ral",
        totalBenefit: "Total",
        cashBack: "Remboursement",
        warnings: "‚ö†Ô∏è Avertissements:",
        missingUnionDues: "Cotisations syndicales manquantes",
        missingSIN: "NAS manquant",
        invalidRL1: "‚ùå RL-1 invalide ‚Äî v√©rifiez cas A"
      }
    };

    let lang = 'en';
    const _ = (key) => translations[lang][key] || key;

    function setLang(newLang) {
      lang = newLang;
      document.getElementById('btn-en').style.fontWeight = lang === 'en' ? 'bold' : 'normal';
      document.getElementById('btn-fr').style.fontWeight = lang === 'fr' ? 'bold' : 'normal';
      updateUI();
    }

    function updateUI() {
      document.getElementById('title').textContent = _('title');
      document.getElementById('subtitle').innerHTML = `<strong>${_('subtitle')}</strong>`;
      document.getElementById('paste-label').textContent = _('pasteLabel');
    }

    function clearForm() {
      document.getElementById('textInput').value = '';
      document.getElementById('output').innerHTML = '';
    }

    function parseRL1(text) {
      const clean = text.replace(/\s+/g, ' ').trim();
      const extract = (regex) => {
        const m = clean.match(regex);
        return m ? parseFloat(m[1].replace(/,/g, '')) || 0 : null;
      };
      return {
        income: extract(/Case\s+A[:\s]*([\d,]+\.?\d*)/i),
        unionDues: extract(/Case\s+L[:\s]*([\d,]+\.?\d*)/i),
        sin: clean.match(/S\.I\.N\.\s*[:\-]?\s*(\d{3}\s?\d{3}\s?\d{3})/i)?.[1] || null,
        isValid: function() { return this.income > 0; },
        warnings: function() {
          const w = [];
          if (this.unionDues === null) w.push(_('missingUnionDues'));
          if (!this.sin) w.push(_('missingSIN'));
          return w;
        }
      };
    }

    function calculateSolidarity(income) {
      const BASE = 531, START = 57965, END = 64125;
      let amt = BASE;
      if (income > START) {
        if (income >= END) amt = 0;
        else amt *= (1 - (income - START) / (END - START));
      }
      return Math.round(amt * 100) / 100;
    }

    function calculateWorkPremium(income) {
      if (income < 7200) return 0;
      const base = Math.min(income - 7200, 33100);
      return Math.min(Math.round(base * 0.26 * 100) / 100, 728);
    }

    function estimateFederal(income) {
      let cwb = 0;
      if (income <= 25539) cwb = Math.min(income * 0.27, 1519);
      else if (income <= 35539) cwb = Math.max(0, 1519 - (income - 25539) * 0.15);
      const bpa = Math.max(0, 15705 - Math.max(0, income - 165430) * 15705 / 70000);
      return { cwb: Math.round(cwb * 100) / 100, bpaSavings: Math.round(bpa * 0.15 * 100) / 100 };
    }

    function estimate() {
      const text = document.getElementById('textInput').value;
      if (!text.trim()) {
        document.getElementById('output').innerHTML = `<p style="color:red">${_('invalidRL1')}</p>`;
        return;
      }

      const data = parseRL1(text);
      if (!data.isValid()) {
        document.getElementById('output').innerHTML = `<p style="color:red">${_('invalidRL1')}</p>`;
        return;
      }

      const income = data.income;
      const qc = { solidarity: calculateSolidarity(income), workPremium: calculateWorkPremium(income) };
      const fed = estimateFederal(income);
      const qcTotal = qc.solidarity + qc.workPremium;
      const totalBenefit = qcTotal + fed.bpaSavings + fed.cwb;
      const cashBack = qc.workPremium + fed.cwb;

      let html = `<div class="result" style="display:block;">
        <h3>üßæ ${lang === 'fr' ? 'Estimation 2025' : 'Estimate 2025'}</h3>
        <p>üíº ${_('income')}: $${income.toLocaleString()}</p>
        <h4>üá∂üá® ${lang === 'fr' ? 'Qu√©bec' : 'Quebec'}</h4>
        <p>üí∞ ${_('solidarity')}: $${qc.solidarity}</p>
        <p>üë∑ ${_('workPremium')}: $${qc.workPremium}</p>
        <p><strong>‚úÖ ${_('qcTotal')}: $${qcTotal.toFixed(2)}</strong></p>
        <h4>üá®üá¶ ${lang === 'fr' ? 'F√©d√©ral' : 'Federal'}</h4>
        <p>üõ°Ô∏è ${_('bpaSavings')}: $${fed.bpaSavings}</p>
        <p>üíµ ${_('cwb')}: $${fed.cwb}</p>
        <p><strong>‚úÖ ${_('fedTotal')}: $${(fed.bpaSavings + fed.cwb).toFixed(2)}</strong></p>
        <p><strong>üéØ ${_('totalBenefit')}: $${totalBenefit.toFixed(2)}</strong></p>
        <p><strong>üí∏ ${_('cashBack')}: $${cashBack.toFixed(2)}</strong></p>
      </div>`;

      const warns = data.warnings();
      if (warns.length > 0) {
        html += `<div class="warning"><strong>${_('warnings')}</strong><ul>`;
        warns.forEach(w => html += `<li>${w}</li>`);
        html += '</ul></div>';
      }

      document.getElementById('output').innerHTML = html;
    }

    document.getElementById('fileInput').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt) => document.getElementById('textInput').value = evt.target.result;
      reader.readAsText(file);
    });

    updateUI();
  </script>
</body>
</html>
